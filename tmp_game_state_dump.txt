import 'player_state_dto.dart';
import 'snake_dto.dart';
import 'ladder_dto.dart';

class GameStateDto {
  final String id;
  final List<PlayerStateDto> players;
  final String status;
  final List<SnakeDto> snakes;
  final List<LadderDto> ladders;

  GameStateDto({
    required this.id,
    required this.players,
    required this.status,
    List<SnakeDto>? snakes,
    List<LadderDto>? ladders,
  })  : snakes = snakes ?? [],
        ladders = ladders ?? [];

  factory GameStateDto.fromJson(Map<String, dynamic> json) {
    final dynamic playersRawDyn = json['players'] ?? json['Players'] ?? json['playersList'] ?? json['playersData'];
    List<dynamic> playersRaw = [];
    if (playersRawDyn is List) {
      playersRaw = playersRawDyn;
    } else if (playersRawDyn is Map) {
      playersRaw = playersRawDyn.values.toList();
    }

    final players = playersRaw
        .map((e) => PlayerStateDto.fromJson(e is Map<String, dynamic> ? e : Map<String, dynamic>.from(e)))
        .toList();

    final boardRaw = (json['board'] ?? json['Board']) as Map<String, dynamic>?;

    List<SnakeDto> parseSnakes(dynamic raw) {
      if (raw == null) return [];
      if (raw is List) return raw.map((e) => SnakeDto.fromJson(Map<String, dynamic>.from(e))).toList();
      return [];
    }

    List<LadderDto> parseLadders(dynamic raw) {
      if (raw == null) return [];
      if (raw is List) return raw.map((e) => LadderDto.fromJson(Map<String, dynamic>.from(e))).toList();
      return [];
    }

    final snakes = parseSnakes(boardRaw?['snakes'] ?? boardRaw?['Snakes'] ?? json['snakes']);
    final ladders = parseLadders(boardRaw?['ladders'] ?? boardRaw?['Ladders'] ?? json['ladders']);

    String? topCurrentPlayerId = (json['currentPlayerId'] ?? json['currentPlayer'] ?? json['currentTurnId'])?.toString();
    String? topCurrentPlayerName = (json['currentTurnUsername'] ?? json['currentPlayerName'] ?? json['current_name'] ?? json['currentName'])?.toString();

    bool anyTurn = players.any((p) => p.isTurn == true);
    if (!anyTurn) {
      final normId = topCurrentPlayerId?.trim() ?? '';
      final normName = topCurrentPlayerName?.trim().toLowerCase() ?? '';
      if (normId.isNotEmpty || normName.isNotEmpty) {
        final adjusted = players.map((p) {
          final matchById = normId.isNotEmpty && p.id.toString().trim() == normId;
          final matchByName = normName.isNotEmpty && p.username.trim().toLowerCase() == normName;
          if (matchById || matchByName) {
            return PlayerStateDto(id: p.id, username: p.username, position: p.position, isTurn: true);
          }
          return PlayerStateDto(id: p.id, username: p.username, position: p.position, isTurn: p.isTurn);
        }).toList();
        return GameStateDto(
          id: (json['id'] ?? json['gameId'])?.toString() ?? '',
          players: adjusted,
          status: (json['status'] ?? json['gameStatus'])?.toString() ?? 'unknown',
          snakes: snakes,
          ladders: ladders,
        );
      }

      final dynamic idxRaw = json['currentPlayerIndex'] ?? json['currentTurnIndex'] ?? json['currentIndex'] ?? json['turn'] ?? json['currentTurn'];
      if (idxRaw != null) {
        int? idx;
        if (idxRaw is int) idx = idxRaw;
        else if (idxRaw is String) idx = int.tryParse(idxRaw);
        else if (idxRaw is double) idx = idxRaw.toInt();

        if (idx != null && players.isNotEmpty) {
          if (idx > 0 && idx <= players.length) idx = idx - 1; // normalize 1-based
          if (idx >= 0 && idx < players.length) {
            final adjusted = List<PlayerStateDto>.from(players);
            final p = adjusted[idx];
            adjusted[idx] = PlayerStateDto(id: p.id, username: p.username, position: p.position, isTurn: true);
            return GameStateDto(
              id: (json['id'] ?? json['gameId'])?.toString() ?? '',
              players: adjusted,
              status: (json['status'] ?? json['gameStatus'])?.toString() ?? 'unknown',
              snakes: snakes,
              ladders: ladders,
            );
          }
        }
      }
    }

    return GameStateDto(
      id: (json['id'] ?? json['gameId'])?.toString() ?? '',
      players: players,
      status: (json['status'] ?? json['gameStatus'])?.toString() ?? 'unknown',
      snakes: snakes,
      ladders: ladders,
    );
  }
}

